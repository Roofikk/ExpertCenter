@using ExpertCenter.MvcApp.Models.PriceList
@model PriceListDetailsModel

@{
    ViewData["Title"] = Model.PriceListName;
}

<h1>Прайс лист: @Model.PriceListName</h1>
<div class="row justify-content-between">
    <div class="col-auto">
        <a asp-controller="Products"
           asp-action="Create"
           asp-route-priceListId="@Model.PriceListId"
           class="col-auto btn btn-success">Создать новый товар</a>
        <a asp-action="Index" class="btn btn-secondary">Вернуться к списку</a>
    </div>
    <div class="col-5">
        <div class="dropdown float-end">
            <button id="dropdownMenuSortBy"
                    class="btn btn-primary dropdown-toggle"
                    type="button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
                Сортировка
            </button>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuSortBy">
                <div class="container">
                    @foreach (var sortBy in Model.SortByModel)
                    {
                        <div class="row justify-content-between align-items-center mb-2" style="min-width: 240px">
                            <div class="col-8 flex-grow-1">
                                @sortBy.ColumnName
                            </div>
                            <div class="col-4">
                                <a asp-action="Details"
                                   asp-route-id="@Model.PriceListId"
                                   asp-route-sortBy="@sortBy.ColumnId"
                                   class="btn btn-sm btn-secondary"><span>&#8595;</span></a>
                                <a asp-action="Details"
                                   asp-route-id="@Model.PriceListId"
                                   asp-route-sortBy="@sortBy.ColumnId"
                                   asp-route-isDesc="true"
                                   class="btn btn-sm btn-secondary"><span>&#8593;</span></a>
                            </div>
                        </div>
                    }
                    <hr class="dropdown-divider" />
                    <a asp-action="Details"
                       asp-route-priceListId="@Model.PriceListId"
                       class="dropdown-item">По умолчанию</a>
                </div>
            </div>
        </div>
    </div>
</div>
<hr />
<div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Наименование</th>
                <th>Артикул</th>
                @foreach (var column in Model.ProdColumns)
                {
                    <th>@column.Key.ColumnName</th>
                }
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Products)
            {
                <tr>
                    <td>@item.ProductName</td>
                    <td>@item.Article</td>
                    @foreach (var column in Model.ProdColumns)
                    {
                        <td>@column.Value[item.ProductId]</td>
                    }
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct(@item.ProductId)">Удалить</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div id="pagination">
        @await Html.PartialAsync("_PaginationBar", Model.PaginationBarModel)
    </div>
</div>

@section Scripts
{
    <script>
        function deleteProduct(id) {
            $.ajax({
                url: '@Url.Action("Delete", "Products")/' + id,
                type: 'GET',
                data: id,
                success: function (response) {
                    $('body').append(response);
                    var deleteModal = $('#deleteModal');
                    var form = deleteModal.find('form');
                    var queryValues = window.location.search.substring(1).split('&').reduce(function (map, obj) {
                        var parts = obj.split('=');
                        map[parts[0]] = parts[1];
                        return map;
                    }, {});
                    console.log(queryValues);
                    form.append(`<input name="PriceListId" value="@Model.PriceListId" type="hidden" />`);
                    form.append(`<input name="SortByModel.ColumnId" value="${queryValues?.sortBy ?? ""}" type="hidden" />`);
                    form.append(`<input name="SortByModel.IsDesc" value="${queryValues?.isDesc ?? false}" type="hidden" />`);
                    form.append(`<input name="PageIndex" value="${queryValues?.pageIndex ?? 1}" type="hidden" />`);
                    $('#deleteModal').modal('show');

                    $('#deleteModal').on('hidden.bs.modal', function () {
                        $(this).remove();
                    });
                },
                error: function (xhr, status, error) {
                }
            });
        }
    </script>
}
